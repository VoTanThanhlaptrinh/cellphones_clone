<div class="flex flex-col static">
    <app-header-cart-order [totalQuantity]="this.totalQuantity" [Username]="username()" />

    <div class="bg-gray-100 min-h-160 overflow-x-auto static">
        <div class="mx-auto max-w-150 p-2 gap-y-4 flex flex-col">
            <!-- Header -->
            <div class="flex flex-row items-center justify-between w-full p-2">
                <svg routerLink="/cart" class="cursor-pointer" width="20" height="17" viewBox="0 0 20 17" fill="none"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 8.5L1 8.5M1 8.5L8 1M1 8.5L8 16" stroke="#121219" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round"></path>
                </svg>
                <p class="text-center text-black text-lg font-medium">Chi tiết & Hình thức nhận hàng</p>
                <div></div>
            </div>
            <hr class="grow border-t border-gray-200 mb-2" />

            <!-- Order Summary -->
            <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-y-4">
                <h2 class="text-lg font-medium text-black">Sản phẩm đã chọn</h2>
                <div class="flex flex-col gap-y-3">
                    @for (item of cartItems; track item.cartDetailId) {
                    <div class="flex flex-row justify-between items-center bg-gray-50 p-2 rounded">
                        <div class="flex flex-col">
                            <p class="text-black font-medium">{{ item.productName || 'Sản phẩm' }}</p>
                            <p class="text-sm text-gray-500">Màu/Phiên bản mặc định x {{ item.quantity }}</p>
                        </div>
                        <p class="text-red-600 font-medium">{{ convertPriceVnd(item.salePrice) }}</p>
                    </div>
                    }
                </div>
                <hr class="border-t border-gray-200" />
                <div class="flex flex-row justify-between items-center">
                    <p class="text-black font-medium">Tổng tiền ({{ totalQuantity }} sản phẩm):</p>
                    <p class="text-red-700 font-bold text-lg">{{ convertPriceVnd(totalPrice) }}</p>
                </div>
            </div>

            <!-- Fulfillment Method -->
            <div class="bg-white rounded-lg shadow p-4 flex flex-col gap-y-4">
                <h2 class="text-lg font-medium text-black">Hình thức nhận hàng & Thanh toán</h2>

                <div class="flex flex-col gap-y-3">
                    <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50"
                        [ngClass]="{'border-red-500 bg-red-50': fulfillmentMethod === 'PAY_ON_PICKUP', 'border-gray-200': fulfillmentMethod !== 'PAY_ON_PICKUP'}">
                        <input type="radio" name="fulfillmentMethod" value="PAY_ON_PICKUP"
                            [(ngModel)]="fulfillmentMethod" class="w-5 h-5 text-red-600 focus:ring-red-500">
                        <div class="ml-3 flex flex-col w-full">
                            <span class="text-black font-medium">Thanh toán khi nhận hàng tại shop</span>
                            <span class="text-sm text-gray-500">Đến trực tiếp cửa hàng để nhận máy và thanh toán</span>

                            @if (fulfillmentMethod === 'PAY_ON_PICKUP') {
                            <div class="mt-3">
                                <label class="block text-sm font-medium text-gray-700 mb-1">Chọn cửa hàng</label>
                                <select [(ngModel)]="selectedStore"
                                    class="w-full border border-gray-300 rounded p-2 text-black">
                                    <option [ngValue]="null" disabled selected>-- Vui lòng chọn cửa hàng --</option>
                                    @for (store of stores; track store.id) {
                                    <option [value]="store.id">{{ store.name }}</option>
                                    }
                                </select>
                            </div>
                            }
                        </div>
                    </label>

                    <label class="flex items-center p-3 border rounded cursor-pointer hover:bg-gray-50"
                        [ngClass]="{'border-red-500 bg-red-50': fulfillmentMethod === 'ONLINE', 'border-gray-200': fulfillmentMethod !== 'ONLINE'}">
                        <input type="radio" name="fulfillmentMethod" value="ONLINE" [(ngModel)]="fulfillmentMethod"
                            class="w-5 h-5 text-red-600 focus:ring-red-500">
                        <div class="ml-3 flex flex-col">
                            <span class="text-black font-medium">Thanh toán trực tuyến (Giao hàng)</span>
                            <span class="text-sm text-gray-500">Thanh toán trước qua ví điện tử hoặc thẻ ngân
                                hàng</span>
                        </div>
                    </label>
                </div>
            </div>
        </div>
        <div class="min-h-[15vh]"></div>

        <!-- Bottom Sticky Bar -->
        <div
            class="fixed flex bottom-0 sm:w-full bg-white left-115 items-center pb-2 pt-2 flex-col rounded-sm shadow-[0_-4px_20px_-1px_rgba(40,124,234,.15)] px-2 max-w-150 w-150 rounded-t-lg z-50">
            <div class="flex flex-row justify-between w-full px-2 pb-2">
                <p class="text-black font-medium">Tổng thanh toán:</p>
                <p class="text-red-700 font-bold text-lg">{{ convertPriceVnd(totalPrice) }}</p>
            </div>

            <button
                class="btn rounded-lg border-transparent text-white h-12 w-full px-2 py-1 font-medium text-lg uppercase"
                [ngClass]="(fulfillmentMethod === 'PAY_ON_PICKUP' && !selectedStore) ? 'bg-gray-400 cursor-not-allowed' : 'bg-red-700'"
                [disabled]="fulfillmentMethod === 'PAY_ON_PICKUP' && !selectedStore || isLoading()" (click)="proceed()">
                @if (isLoading()) {
                Đang xử lý...
                } @else if (fulfillmentMethod === 'PAY_ON_PICKUP') {
                Xác nhận đặt hàng
                } @else {
                Tiến hành thanh toán
                }
            </button>

        </div>
    </div>
</div>